<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Guru Komprehensif</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better content display */
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 900px;
            padding: 30px;
            box-sizing: border-box;
        }
        .hidden {
            display: none;
        }
        .btn {
            @apply px-6 py-3 rounded-lg font-semibold transition-all duration-200;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700 shadow-md;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 hover:bg-gray-300;
        }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .select-field {
            @apply w-full p-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        table {
            @apply w-full text-left border-collapse;
        }
        th, td {
            @apply p-3 border-b border-gray-200;
        }
        th {
            @apply bg-gray-50 text-gray-700 font-medium;
        }
        tr:nth-child(even) {
            @apply bg-gray-50;
        }
        .message-box {
            @apply fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50;
        }
        .message-content {
            @apply bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center;
        }
        .message-content button {
            @apply mt-4 px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700;
        }
    </style>
</head>
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDufgc522J2I5v3_x2dKd0ntq8KBV-s1f4",
    authDomain: "guruspanluh.firebaseapp.com",
    projectId: "guruspanluh",
    storageBucket: "guruspanluh.firebasestorage.app",
    messagingSenderId: "842436407311",
    appId: "1:842436407311:web:ce39edf59f01fef071f37a"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>
<body>
    <div class="container">
        <!-- Message Box -->
        <div id="messageBox" class="message-box hidden">
            <div class="message-content">
                <p id="messageText" class="text-lg font-medium"></p>
                <button onclick="hideMessageBox()">OK</button>
            </div>
        </div>

        <!-- Halaman Login -->
        <div id="loginPage" class="flex flex-col items-center justify-center min-h-[500px]">
            <h2 class="text-3xl font-bold text-gray-800 mb-8">Selamat Datang di Aplikasi Guru</h2>
            <div class="w-full max-w-sm bg-white p-8 rounded-xl shadow-lg">
                <h3 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Login Guru</h3>
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 text-sm font-medium mb-2">Username:</label>
                    <input type="text" id="username" class="input-field" placeholder="Masukkan username">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 text-sm font-medium mb-2">Password:</label>
                    <input type="password" id="password" class="input-field" placeholder="Masukkan password">
                </div>
                <button id="loginBtn" class="btn btn-primary w-full">Login</button>
                <p class="text-sm text-gray-500 mt-4 text-center">Gunakan username: guru, password: 123</p>
            </div>
        </div>

        <!-- Dashboard (Setelah Login) -->
        <div id="dashboardPage" class="hidden">
            <div class="flex justify-between items-center mb-8 pb-4 border-b border-gray-200">
                <h2 id="welcomeMessage" class="text-3xl font-bold text-gray-800"></h2>
                <button id="logoutBtn" class="btn btn-secondary">Logout</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-blue-50 p-6 rounded-xl shadow-md flex flex-col items-center justify-center text-center">
                    <h3 class="text-xl font-semibold text-blue-700 mb-4">Input Daftar Hadir</h3>
                    <p class="text-gray-600 mb-6">Catat kehadiran siswa dengan cepat dan mudah.</p>
                    <button id="goToAttendanceBtn" class="btn btn-primary w-full">Buka Halaman Hadir</button>
                </div>
                <div class="bg-green-50 p-6 rounded-xl shadow-md flex flex-col items-center justify-center text-center">
                    <h3 class="text-xl font-semibold text-green-700 mb-4">Input Nilai & Jurnal</h3>
                    <p class="text-gray-600 mb-6">Masukkan nilai harian dan jurnal singkat siswa.</p>
                    <button id="goToGradesBtn" class="btn btn-primary w-full">Buka Halaman Nilai</button>
                </div>
                <div class="bg-purple-50 p-6 rounded-xl shadow-md flex flex-col items-center justify-center text-center">
                    <h3 class="text-xl font-semibold text-purple-700 mb-4">Rekap Data Siswa</h3>
                    <p class="text-gray-600 mb-6">Lihat rekapitulasi kehadiran dan nilai siswa.</p>
                    <button id="goToRecapBtn" class="btn btn-primary w-full">Buka Halaman Rekap</button>
                </div>
            </div>
        </div>

        <!-- Halaman Input Daftar Hadir Siswa -->
        <div id="attendancePage" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Input Daftar Hadir Siswa</h2>
            <div class="flex items-center space-x-4 mb-6">
                <select id="attendanceClassSelect" class="select-field flex-1">
                    <option value="">Pilih Kelas</option>
                </select>
                <input type="date" id="attendanceDate" class="input-field flex-1">
                <button id="loadAttendanceBtn" class="btn btn-primary">Muat Daftar Siswa</button>
            </div>

            <div id="attendanceListContainer" class="hidden">
                <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Nama Siswa</th>
                                <th>Status Kehadiran</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <!-- Student list will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <button id="saveAttendanceBtn" class="btn btn-primary mt-6 w-full">Simpan Daftar Hadir</button>
            </div>
            <button id="backFromAttendanceBtn" class="btn btn-secondary mt-6">Kembali ke Dashboard</button>
        </div>

        <!-- Halaman Input Nilai Harian Siswa -->
        <div id="gradesPage" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Input Nilai Harian Siswa & Jurnal Singkat</h2>
            <div class="flex items-center space-x-4 mb-6">
                <select id="gradesClassSelect" class="select-field flex-1">
                    <option value="">Pilih Kelas</option>
                </select>
                <select id="gradesSubjectSelect" class="select-field flex-1">
                    <option value="">Pilih Mata Pelajaran</option>
                </select>
                <input type="date" id="gradesDate" class="input-field flex-1">
                <button id="loadGradesBtn" class="btn btn-primary">Muat Daftar Siswa</button>
            </div>

            <div id="gradesListContainer" class="hidden">
                <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Nama Siswa</th>
                                <th>Nilai (0-100)</th>
                                <th>Jurnal Singkat</th>
                            </tr>
                        </thead>
                        <tbody id="gradesTableBody">
                            <!-- Student list will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <button id="saveGradesBtn" class="btn btn-primary mt-6 w-full">Simpan Nilai & Jurnal</button>
            </div>
            <button id="backFromGradesBtn" class="btn btn-secondary mt-6">Kembali ke Dashboard</button>
        </div>

        <!-- Halaman Rekap Data Siswa -->
        <div id="recapPage" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Rekap Data Siswa</h2>
            <div class="flex flex-wrap items-center gap-4 mb-6">
                <select id="recapClassSelect" class="select-field flex-1 min-w-[150px]">
                    <option value="">Pilih Kelas</option>
                </select>
                <select id="recapDataTypeSelect" class="select-field flex-1 min-w-[150px]">
                    <option value="attendance">Rekap Kehadiran</option>
                    <option value="grades">Rekap Nilai</option>
                </select>
                <select id="recapPeriodSelect" class="select-field flex-1 min-w-[150px]">
                    <option value="daily">Harian</option>
                    <option value="weekly">Mingguan</option>
                    <option value="monthly">Bulanan</option>
                </select>
                <input type="date" id="recapStartDate" class="input-field flex-1 min-w-[150px]">
                <input type="date" id="recapEndDate" class="input-field flex-1 min-w-[150px]">
                <button id="loadRecapBtn" class="btn btn-primary flex-none">Muat Rekap</button>
            </div>

            <div id="recapResultsContainer" class="hidden">
                <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                    <table id="recapTable" class="min-w-full">
                        <thead>
                            <tr id="recapTableHeader">
                                <!-- Header will be loaded here -->
                            </tr>
                        </thead>
                        <tbody id="recapTableBody">
                            <!-- Recap data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <button id="exportRecapBtn" class="btn btn-secondary mt-6 w-full">Ekspor Rekap (PDF/Excel)</button>
            </div>
            <button id="backFromRecapBtn" class="btn btn-secondary mt-6">Kembali ke Dashboard</button>
        </div>
    </div>

    <script>
        // --- Data Mock (Simulasi Database) ---
        let currentUser = null;
        // Variabel global untuk data kelas, siswa, dan mata pelajaran
        // Ini akan diisi dari data JSON
        let classes = [];
        let students = {}; // Objek ini akan memetakan classId ke array siswa
        let subjects = [];

        // Data yang akan disimpan (simulasi in-memory)
        let attendanceData = []; // { classId, date, studentId, status: 'Hadir'|'Sakit'|'Izin'|'Alfa' }
        let gradeData = [];      // { classId, subjectId, date, studentId, grade, journal }

        // --- Elemen DOM ---
        const loginPage = document.getElementById('loginPage');
        const dashboardPage = document.getElementById('dashboardPage');
        const attendancePage = document.getElementById('attendancePage');
        const gradesPage = document.getElementById('gradesPage');
        const recapPage = document.getElementById('recapPage');

        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const welcomeMessage = document.getElementById('welcomeMessage');

        const goToAttendanceBtn = document.getElementById('goToAttendanceBtn');
        const goToGradesBtn = document.getElementById('goToGradesBtn');
        const goToRecapBtn = document.getElementById('goToRecapBtn');

        const attendanceClassSelect = document.getElementById('attendanceClassSelect');
        const attendanceDateInput = document.getElementById('attendanceDate');
        const loadAttendanceBtn = document.getElementById('loadAttendanceBtn');
        const attendanceListContainer = document.getElementById('attendanceListContainer');
        const attendanceTableBody = document.getElementById('attendanceTableBody');
        const saveAttendanceBtn = document.getElementById('saveAttendanceBtn');
        const backFromAttendanceBtn = document.getElementById('backFromAttendanceBtn');

        const gradesClassSelect = document.getElementById('gradesClassSelect');
        const gradesSubjectSelect = document.getElementById('gradesSubjectSelect');
        const gradesDateInput = document.getElementById('gradesDate');
        const loadGradesBtn = document.getElementById('loadGradesBtn');
        const gradesListContainer = document.getElementById('gradesListContainer');
        const gradesTableBody = document.getElementById('gradesTableBody');
        const saveGradesBtn = document.getElementById('saveGradesBtn');
        const backFromGradesBtn = document.getElementById('backFromGradesBtn');

        const recapClassSelect = document.getElementById('recapClassSelect');
        const recapDataTypeSelect = document.getElementById('recapDataTypeSelect');
        const recapPeriodSelect = document.getElementById('recapPeriodSelect');
        const recapStartDateInput = document.getElementById('recapStartDate');
        const recapEndDateInput = document.getElementById('recapEndDate');
        const loadRecapBtn = document.getElementById('loadRecapBtn');
        const recapResultsContainer = document.getElementById('recapResultsContainer');
        const recapTable = document.getElementById('recapTable');
        const recapTableHeader = document.getElementById('recapTableHeader');
        const recapTableBody = document.getElementById('recapTableBody');
        const exportRecapBtn = document.getElementById('exportRecapBtn');
        const backFromRecapBtn = document.getElementById('backFromRecapBtn');

        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        // --- Fungsi Utilitas ---

        /**
         * Menampilkan pesan pop-up kustom.
         * @param {string} message - Pesan yang akan ditampilkan.
         */
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        /**
         * Menyembunyikan pesan pop-up kustom.
         */
        function hideMessageBox() {
            messageBox.classList.add('hidden');
        }

        /**
         * Mengubah tampilan halaman.
         * @param {HTMLElement} pageToShow - Halaman yang akan ditampilkan.
         */
        function showPage(pageToShow) {
            [loginPage, dashboardPage, attendancePage, gradesPage, recapPage].forEach(page => {
                page.classList.add('hidden');
            });
            pageToShow.classList.remove('hidden');
        }

        /**
         * Mengisi dropdown kelas.
         * @param {HTMLSelectElement} selectElement - Elemen select yang akan diisi.
         */
        function populateClassSelect(selectElement) {
            selectElement.innerHTML = '<option value="">Pilih Kelas</option>';
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                selectElement.appendChild(option);
            });
        }

        /**
         * Mengisi dropdown mata pelajaran.
         * @param {HTMLSelectElement} selectElement - Elemen select yang akan diisi.
         */
        function populateSubjectSelect(selectElement) {
            selectElement.innerHTML = '<option value="">Pilih Mata Pelajaran</option>';
            subjects.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = sub.name;
                selectElement.appendChild(option);
            });
        }

        /**
         * Mengambil nama kelas berdasarkan ID.
         * @param {string} classId - ID kelas.
         * @returns {string} Nama kelas.
         */
        function getClassName(classId) {
            const cls = classes.find(c => c.id === classId);
            return cls ? cls.name : 'Tidak Dikenal';
        }

        /**
         * Mengambil nama mata pelajaran berdasarkan ID.
         * @param {string} subjectId - ID mata pelajaran.
         * @returns {string} Nama mata pelajaran.
         */
        function getSubjectName(subjectId) {
            const sub = subjects.find(s => s.id === subjectId);
            return sub ? sub.name : 'Tidak Dikenal';
        }

        /**
         * Mengambil nama siswa berdasarkan ID.
         * @param {string} classId - ID kelas siswa.
         * @param {string} studentId - ID siswa.
         * @returns {string} Nama siswa.
         */
        function getStudentName(classId, studentId) {
            const studentList = students[classId] || [];
            const student = studentList.find(s => s.id === studentId);
            return student ? student.name : 'Tidak Dikenal';
        }

        /**
         * Memuat data kelas, siswa, dan mata pelajaran dari objek data.
         * @param {object} data - Objek data yang berisi classes dan subjects.
         */
        function processLoadedData(data) {
            classes = data.classes || [];
            subjects = data.subjects || [];

            // Transformasi data kelas menjadi objek siswa yang diharapkan oleh bagian lain kode
            students = {};
            classes.forEach(cls => {
                students[cls.id] = cls.students || [];
            });
            showMessageBox('Data siswa dan kelas berhasil dimuat.');
        }

        // --- Fungsi Login/Logout ---
        loginBtn.addEventListener('click', () => {
            const username = usernameInput.value;
            const password = passwordInput.value;

            // Simulasi login (username: guru, password: 123)
            if (username === 'guru' && password === '123') {
                currentUser = { name: 'Bapak/Ibu Guru' }; // Bisa diganti dengan nama guru yang sebenarnya
                welcomeMessage.textContent = `Selamat datang, ${currentUser.name}!`;
                showPage(dashboardPage);
                usernameInput.value = '';
                passwordInput.value = '';
            } else {
                showMessageBox('Username atau password salah. Silakan coba lagi.');
            }
        });

        logoutBtn.addEventListener('click', () => {
            currentUser = null;
            showPage(loginPage);
        });

        // --- Navigasi Dashboard ---
        goToAttendanceBtn.addEventListener('click', () => {
            showPage(attendancePage);
            populateClassSelect(attendanceClassSelect); // Isi dropdown kelas setelah data dimuat
            attendanceDateInput.valueAsDate = new Date(); // Set tanggal hari ini
            attendanceListContainer.classList.add('hidden'); // Sembunyikan daftar siswa
            attendanceTableBody.innerHTML = ''; // Kosongkan tabel
        });

        goToGradesBtn.addEventListener('click', () => {
            showPage(gradesPage);
            populateClassSelect(gradesClassSelect);     // Isi dropdown kelas setelah data dimuat
            populateSubjectSelect(gradesSubjectSelect); // Isi dropdown mapel setelah data dimuat
            gradesDateInput.valueAsDate = new Date(); // Set tanggal hari ini
            gradesListContainer.classList.add('hidden'); // Sembunyikan daftar siswa
            gradesTableBody.innerHTML = ''; // Kosongkan tabel
        });

        goToRecapBtn.addEventListener('click', () => {
            showPage(recapPage);
            populateClassSelect(recapClassSelect); // Isi dropdown kelas setelah data dimuat
            // Set default dates for recap to last 7 days
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 6); // Set to 6 days before today for a 7-day range
            recapStartDateInput.valueAsDate = sevenDaysAgo;
            recapEndDateInput.valueAsDate = today;
            recapResultsContainer.classList.add('hidden'); // Sembunyikan hasil rekap
            recapTableBody.innerHTML = ''; // Kosongkan tabel
            recapTableHeader.innerHTML = ''; // Kosongkan header tabel
        });

        backFromAttendanceBtn.addEventListener('click', () => showPage(dashboardPage));
        backFromGradesBtn.addEventListener('click', () => showPage(dashboardPage));
        backFromRecapBtn.addEventListener('click', () => showPage(dashboardPage));

        // --- Halaman Input Daftar Hadir ---
        loadAttendanceBtn.addEventListener('click', () => {
            const selectedClassId = attendanceClassSelect.value;
            const selectedDate = attendanceDateInput.value;

            if (!selectedClassId || !selectedDate) {
                showMessageBox('Harap pilih kelas dan tanggal.');
                return;
            }

            const studentsInClass = students[selectedClassId] || [];
            attendanceTableBody.innerHTML = ''; // Clear previous list

            if (studentsInClass.length === 0) {
                showMessageBox('Tidak ada siswa di kelas ini.');
                attendanceListContainer.classList.add('hidden');
                return;
            }

            studentsInClass.forEach((student, index) => {
                const row = document.createElement('tr');
                const existingAttendance = attendanceData.find(
                    a => a.classId === selectedClassId && a.date === selectedDate && a.studentId === student.id
                );
                const status = existingAttendance ? existingAttendance.status : 'Hadir'; // Default to Hadir

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${student.name}</td>
                    <td>
                        <label class="inline-flex items-center mr-4">
                            <input type="radio" name="status-${student.id}" value="Hadir" ${status === 'Hadir' ? 'checked' : ''} class="form-radio text-blue-600">
                            <span class="ml-2">Hadir</span>
                        </label>
                        <label class="inline-flex items-center mr-4">
                            <input type="radio" name="status-${student.id}" value="Sakit" ${status === 'Sakit' ? 'checked' : ''} class="form-radio text-yellow-600">
                            <span class="ml-2">Sakit</span>
                        </label>
                        <label class="inline-flex items-center mr-4">
                            <input type="radio" name="status-${student.id}" value="Izin" ${status === 'Izin' ? 'checked' : ''} class="form-radio text-green-600">
                            <span class="ml-2">Izin</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="status-${student.id}" value="Alfa" ${status === 'Alfa' ? 'checked' : ''} class="form-radio text-red-600">
                            <span class="ml-2">Alfa</span>
                        </label>
                    </td>
                `;
                attendanceTableBody.appendChild(row);
            });
            attendanceListContainer.classList.remove('hidden');
        });

        saveAttendanceBtn.addEventListener('click', () => {
            const selectedClassId = attendanceClassSelect.value;
            const selectedDate = attendanceDateInput.value;

            if (!selectedClassId || !selectedDate) {
                showMessageBox('Harap pilih kelas dan tanggal sebelum menyimpan.');
                return;
            }

            const studentsInClass = students[selectedClassId] || [];
            if (studentsInClass.length === 0) {
                showMessageBox('Tidak ada siswa untuk disimpan.');
                return;
            }

            let savedCount = 0;

            studentsInClass.forEach(student => {
                const statusInput = document.querySelector(`input[name="status-${student.id}"]:checked`);
                const status = statusInput ? statusInput.value : 'Hadir'; // Default to Hadir if not selected

                // Check if attendance for this student, class, and date already exists
                const existingIndex = attendanceData.findIndex(
                    a => a.classId === selectedClassId && a.date === selectedDate && a.studentId === student.id
                );

                if (existingIndex !== -1) {
                    // Update existing record
                    attendanceData[existingIndex].status = status;
                } else {
                    // Add new record
                    attendanceData.push({
                        classId: selectedClassId,
                        date: selectedDate,
                        studentId: student.id,
                        status: status
                    });
                }
                savedCount++;
            });

            if (savedCount > 0) {
                showMessageBox(`Daftar hadir untuk ${getClassName(selectedClassId)} pada ${selectedDate} berhasil disimpan.`);
            } else {
                showMessageBox('Tidak ada data daftar hadir yang disimpan.');
            }
        });

        // --- Halaman Input Nilai & Jurnal ---
        loadGradesBtn.addEventListener('click', () => {
            const selectedClassId = gradesClassSelect.value;
            const selectedSubjectId = gradesSubjectSelect.value;
            const selectedDate = gradesDateInput.value;

            if (!selectedClassId || !selectedSubjectId || !selectedDate) {
                showMessageBox('Harap pilih kelas, mata pelajaran, dan tanggal.');
                return;
            }

            const studentsInClass = students[selectedClassId] || [];
            gradesTableBody.innerHTML = ''; // Clear previous list

            if (studentsInClass.length === 0) {
                showMessageBox('Tidak ada siswa di kelas ini.');
                gradesListContainer.classList.add('hidden');
                return;
            }

            studentsInClass.forEach((student, index) => {
                const existingGrade = gradeData.find(
                    g => g.classId === selectedClassId && g.subjectId === selectedSubjectId && g.date === selectedDate && g.studentId === student.id
                );
                const gradeValue = existingGrade ? existingGrade.grade : '';
                const journalValue = existingGrade ? existingGrade.journal : '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${student.name}</td>
                    <td><input type="number" min="0" max="100" value="${gradeValue}" data-student-id="${student.id}" class="input-field w-24 grade-input"></td>
                    <td><textarea data-student-id="${student.id}" class="input-field h-20 journal-input" placeholder="Jurnal singkat...">${journalValue}</textarea></td>
                `;
                gradesTableBody.appendChild(row);
            });
            gradesListContainer.classList.remove('hidden');
        });

        saveGradesBtn.addEventListener('click', () => {
            const selectedClassId = gradesClassSelect.value;
            const selectedSubjectId = gradesSubjectSelect.value;
            const selectedDate = gradesDateInput.value;

            if (!selectedClassId || !selectedSubjectId || !selectedDate) {
                showMessageBox('Harap pilih kelas, mata pelajaran, dan tanggal sebelum menyimpan.');
                return;
            }

            const studentsInClass = students[selectedClassId] || [];
            if (studentsInClass.length === 0) {
                showMessageBox('Tidak ada siswa untuk disimpan.');
                return;
            }

            let savedCount = 0;

            studentsInClass.forEach(student => {
                const gradeInput = document.querySelector(`#gradesTableBody input[data-student-id="${student.id}"]`);
                const journalInput = document.querySelector(`#gradesTableBody textarea[data-student-id="${student.id}"]`);

                const grade = gradeInput ? parseInt(gradeInput.value) : null;
                const journal = journalInput ? journalInput.value.trim() : '';

                if (grade !== null && !isNaN(grade)) {
                    // Check if grade for this student, class, subject, and date already exists
                    const existingIndex = gradeData.findIndex(
                        g => g.classId === selectedClassId && g.subjectId === selectedSubjectId && g.date === selectedDate && g.studentId === student.id
                    );

                    if (existingIndex !== -1) {
                        // Update existing record
                        gradeData[existingIndex].grade = grade;
                        gradeData[existingIndex].journal = journal;
                    } else {
                        // Add new record
                        gradeData.push({
                            classId: selectedClassId,
                            subjectId: selectedSubjectId,
                            date: selectedDate,
                            studentId: student.id,
                            grade: grade,
                            journal: journal
                        });
                    }
                    savedCount++;
                }
            });

            if (savedCount > 0) {
                showMessageBox(`Nilai dan jurnal untuk ${getClassName(selectedClassId)} - ${getSubjectName(selectedSubjectId)} pada ${selectedDate} berhasil disimpan.`);
            } else {
                showMessageBox('Tidak ada nilai atau jurnal yang disimpan. Pastikan nilai diisi dengan benar.');
            }
        });

        // --- Halaman Rekap Data Siswa ---
        loadRecapBtn.addEventListener('click', () => {
            const selectedClassId = recapClassSelect.value;
            const dataType = recapDataTypeSelect.value;
            const period = recapPeriodSelect.value;
            const startDate = recapStartDateInput.value;
            const endDate = recapEndDateInput.value;

            if (!selectedClassId || !startDate || !endDate) {
                showMessageBox('Harap pilih kelas, tanggal mulai, dan tanggal akhir.');
                return;
            }

            recapTableBody.innerHTML = '';
            recapTableHeader.innerHTML = '';
            recapResultsContainer.classList.add('hidden');

            const filteredStudents = students[selectedClassId] || [];
            if (filteredStudents.length === 0) {
                showMessageBox('Tidak ada siswa di kelas ini.');
                return;
            }

            if (dataType === 'attendance') {
                renderAttendanceRecap(selectedClassId, period, startDate, endDate, filteredStudents);
            } else if (dataType === 'grades') {
                renderGradesRecap(selectedClassId, period, startDate, endDate, filteredStudents);
            }
            recapResultsContainer.classList.remove('hidden');
        });

        /**
         * Mengambil semua tanggal dalam rentang.
         * @param {string} start - Tanggal mulai (YYYY-MM-DD).
         * @param {string} end - Tanggal akhir (YYYY-MM-DD).
         * @returns {string[]} Array of dates (YYYY-MM-DD).
         */
        function getDatesInRange(start, end) {
            const dates = [];
            let currentDate = new Date(start + 'T00:00:00'); // Add T00:00:00 to avoid timezone issues
            const endDate = new Date(end + 'T00:00:00');
            while (currentDate <= endDate) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        /**
         * Menampilkan rekap kehadiran.
         * @param {string} classId - ID kelas.
         * @param {string} period - Periode rekap (daily, weekly, monthly).
         * @param {string} startDate - Tanggal mulai.
         * @param {string} endDate - Tanggal akhir.
         * @param {Array} studentsInClass - Daftar siswa di kelas.
         */
        function renderAttendanceRecap(classId, period, startDate, endDate, studentsInClass) {
            let headerHtml = '<th>No.</th><th>Nama Siswa</th>';
            let datesToDisplay = [];

            if (period === 'daily') {
                datesToDisplay = getDatesInRange(startDate, endDate);
                datesToDisplay.forEach(date => {
                    headerHtml += `<th>${date}</th>`;
                });
            } else {
                headerHtml += '<th>Hadir</th><th>Sakit</th><th>Izin</th><th>Alfa</th>';
            }
            recapTableHeader.innerHTML = headerHtml;

            studentsInClass.forEach((student, index) => {
                const row = document.createElement('tr');
                let rowHtml = `<td>${index + 1}</td><td>${student.name}</td>`;

                if (period === 'daily') {
                    datesToDisplay.forEach(date => {
                        const attendanceRecord = attendanceData.find(
                            a => a.classId === classId && a.date === date && a.studentId === student.id
                        );
                        rowHtml += `<td>${attendanceRecord ? attendanceRecord.status.charAt(0) : '-'}</td>`; // H, S, I, A
                    });
                } else {
                    const studentAttendance = attendanceData.filter(
                        a => a.classId === classId && a.studentId === student.id && a.date >= startDate && a.date <= endDate
                    );
                    const counts = { Hadir: 0, Sakit: 0, Izin: 0, Alfa: 0 };
                    studentAttendance.forEach(a => counts[a.status]++);
                    rowHtml += `<td>${counts.Hadir}</td><td>${counts.Sakit}</td><td>${counts.Izin}</td><td>${counts.Alfa}</td>`;
                }
                row.innerHTML = rowHtml;
                recapTableBody.appendChild(row);
            });
        }

        /**
         * Menampilkan rekap nilai.
         * @param {string} classId - ID kelas.
         * @param {string} period - Periode rekap (daily, weekly, monthly).
         * @param {string} startDate - Tanggal mulai.
         * @param {string} endDate - Tanggal akhir.
         * @param {Array} studentsInClass - Daftar siswa di kelas.
         */
        function renderGradesRecap(classId, period, startDate, endDate, studentsInClass) {
            let headerHtml = '<th>No.</th><th>Nama Siswa</th>';
            let datesToDisplay = [];

            if (period === 'daily') {
                // For daily, show grades for each subject on each day
                headerHtml += subjects.map(sub => `<th>${sub.name} (Nilai)</th><th>${sub.name} (Jurnal)</th>`).join('');
            } else {
                headerHtml += subjects.map(sub => `<th>${sub.name} (Rata-rata)</th>`).join('');
                headerHtml += '<th>Rata-rata Keseluruhan</th>';
            }
            recapTableHeader.innerHTML = headerHtml;

            studentsInClass.forEach((student, index) => {
                const row = document.createElement('tr');
                let rowHtml = `<td>${index + 1}</td><td>${student.name}</td>`;

                if (period === 'daily') {
                    // Display grades and journals for each subject on each day
                    subjects.forEach(subject => {
                        const gradeRecord = gradeData.find(
                            g => g.classId === classId && g.subjectId === subject.id && g.studentId === student.id && g.date >= startDate && g.date <= endDate
                        );
                        rowHtml += `<td>${gradeRecord ? gradeRecord.grade : '-'}</td>`;
                        rowHtml += `<td>${gradeRecord ? gradeRecord.journal : '-'}</td>`;
                    });
                } else {
                    let overallTotalGrade = 0;
                    let overallGradeCount = 0;

                    subjects.forEach(subject => {
                        const studentGrades = gradeData.filter(
                            g => g.classId === classId && g.subjectId === subject.id && g.studentId === student.id && g.date >= startDate && g.date <= endDate
                        );
                        const totalGrade = studentGrades.reduce((sum, g) => sum + g.grade, 0);
                        const averageGrade = studentGrades.length > 0 ? (totalGrade / studentGrades.length).toFixed(1) : '-';
                        rowHtml += `<td>${averageGrade}</td>`;

                        if (studentGrades.length > 0) {
                            overallTotalGrade += totalGrade;
                            overallGradeCount += studentGrades.length;
                        }
                    });
                    const overallAverage = overallGradeCount > 0 ? (overallTotalGrade / overallGradeCount).toFixed(1) : '-';
                    rowHtml += `<td>${overallAverage}</td>`;
                }
                row.innerHTML = rowHtml;
                recapTableBody.appendChild(row);
            });
        }

        exportRecapBtn.addEventListener('click', () => {
            // Updated message to reflect per-subject export concept for grades
            const dataType = recapDataTypeSelect.value;
            if (dataType === 'grades') {
                showMessageBox('Fungsi ekspor nilai belum diimplementasikan pada versi demo ini. Jika diimplementasikan, ekspor akan disesuaikan per mata pelajaran yang ditampilkan.');
            } else {
                showMessageBox('Fungsi ekspor kehadiran belum diimplementasikan pada versi demo ini.');
            }
        });

        // --- Inisialisasi Aplikasi ---
        document.addEventListener('DOMContentLoaded', () => {
            // Path ke file students.json
            const jsonFilePath = 'students.json';

            // Menggunakan Fetch API untuk memuat file JSON
            fetch(jsonFilePath)
                .then(response => {
                    if (!response.ok) {
                        // Jika respons tidak OK (misal 404 Not Found), lempar error
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json(); // Parse respons sebagai JSON
                })
                .then(data => {
                    processLoadedData(data); // Memproses data yang dimuat
                    showPage(loginPage); // Tampilkan halaman login setelah data dimuat
                })
                .catch(error => {
                    showMessageBox(`Gagal memuat file students.json: ${error.message}. Pastikan file ada dan diakses melalui server web.`);
                    console.error('Error loading students.json:', error);
                    // Fallback to hardcoded data if loading fails
                    const fallbackData = {
                      "classes": [
                        {
                          "id": "class-1",
                          "name": "Kelas 10A",
                          "students": [
                            { "id": "s001", "name": "Andi Pratama" },
                            { "id": "s002", "name": "Budi Santoso" },
                            { "id": "s003", "name": "Citra Dewi" },
                            { "id": "s004", "name": "Dewi Lestari" },
                            { "id": "s005", "name": "Eko Cahyono" }
                          ]
                        },
                        {
                          "id": "class-2",
                          "name": "Kelas 10B",
                          "students": [
                            { "id": "s006", "name": "Fajar Nugraha" },
                            { "id": "s007", "name": "Gita Permata" },
                            { "id": "s008", "name": "Hadi Wijaya" },
                            { "id": "s009", "name": "Indah Sari" },
                            { "id": "s010", "name": "Joko Susanto" }
                          ]
                        },
                        {
                          "id": "class-3",
                          "name": "Kelas 11 IPA 1",
                          "students": [
                            { "id": "s011", "name": "Kusuma Negara" },
                            { "id": "s012", "name": "Lia Amelia" },
                            { "id": "s013", "name": "Mochamad Rizky" },
                            { "id": "s014", "name": "Nia Ramadhani" },
                            { "id": "s015", "name": "Putri Ayu" }
                          ]
                        }
                      ],
                      "subjects": [
                        { "id": "sub-1", "name": "Matematika" },
                        { "id": "sub-2", "name": "Bahasa Indonesia" },
                        { "id": "sub-3", "name": "Ilmu Pengetahuan Alam" },
                        { "id": "sub-4", "name": "Sejarah" },
                        { "id": "sub-5", "name": "Fisika" },
                        { "id": "sub-6", "name": "Informatika" },
                        { "id": "sub-7", "name": "Bahasa Inggris" },
                        { "id": "sub-8", "name": "Agama" },
                        { "id": "sub-9", "name": "Ilmu Pengetahuan Sosial" },
                        { "id": "sub-10", "name": "PPKn" },
                        { "id": "sub-11", "name": "Olahraga" }
                      ]
                    };
                    processLoadedData(fallbackData); // Load hardcoded data as a fallback
                    showPage(loginPage); // Tampilkan halaman login
                });

            // Set default date for attendance and grades input to today
            const today = new Date().toISOString().split('T')[0];
            attendanceDateInput.value = today;
            gradesDateInput.value = today;
        });
    </script>
</body>
</html>
